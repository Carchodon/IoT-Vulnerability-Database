import mysql.connector
import json 
  


# Opening JSON file 
f = open('../../data/nvdcve-1.1-2020.json',) 

##Create the DB connection
database = db()
db_cursor = database.conectar("tfm")


##Load data
data = json.load(f)

##Iterate all items from data
aux = 0
for i in data['CVE_Items']: 
    ##Get identifier
    identifier = i['cve']['CVE_data_meta']['ID']

    ##Get impact but it is possible that it doesn't exixsts, if it is the case, we write a 0
    if i['impact']:
        if 'baseMetricV2' in i['impact']:
            score = i['impact']['baseMetricV2']['cvssV2']['baseScore']
        else:
            score = 0
    else:
        score = 0
    
    ##Get description
    desc = i['cve']['description']['description_data'][0]['value']

    ##get cpe
    encontrado = False
    iter=0
    if i['configurations']['nodes']:
        if 'children' in i['configurations']['nodes'][0]:
            if not i['configurations']['nodes'][0]['children']:
                while (encontrado ==False):
                    if 'cpe23Uri' in i['configurations']['nodes'][0]['cpe_match'][iter]:
                        encontrado = True
                        cpe = i['configurations']['nodes'][0]['cpe_match'][iter]['cpe23Uri']
                    else:
                        iter+=1
            else:
                cpe = i['configurations']['nodes'][0]['children'][0]['cpe_match'][0]['cpe23Uri']
        else:
            cpe = i['configurations']['nodes'][0]['cpe_match'][0]['cpe23Uri']
        
        ##get part and vendor from cpe
        cpe = cpe.split(':')
        letra = cpe[2]
        vendedor = cpe[3]
    else:
        letra = 'n'
        vendedor = 'nada'


    ##Clean the description and the vendor
    desc = desc.replace("'", "")
    vendedor = vendedor.replace("'","")
    
    ##Create the query and execute it
    sql_query = "INSERT INTO vulnerabilidades2020(id,cvss_score,description, part, vendor) VALUES('" + identifier + "', " + str(score) + ",'" +desc + "','" +letra+ "','" +vendedor+"')"
    db_cursor.execute(sql_query)
    aux+=1
    

##Closing file 
f.close() 

##Comit
database.get_conn().commit()
print(db_cursor.rowcount, "Record Inserted")